package com.example.reporting;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Service;
import org.springframework.stereotype.Component;

import javax.persistence.*;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

// Main Application
@SpringBootApplication
public class ReportingApplication implements CommandLineRunner {

    @Autowired
    private ReportingService reportingService;

    public static void main(String[] args) {
        SpringApplication.run(ReportingApplication.class, args);
    }

    @Override
    public void run(String... args) throws Exception {
        List<CategoryResponse> report = reportingService.getReport(1L, 1L, 1L);
        report.forEach(System.out::println);
    }
}

// Reporting Service
@Service
class ReportingService {

    @Autowired
    private JurisdictionRepository jurisdictionRepository;

    @Autowired
    private ObligationRepository obligationRepository;

    @Autowired
    private JurisdictionObligationRepository jurisdictionObligationRepository;

    @Autowired
    private JurisdictionObligationDifferenceRepository jurisdictionObligationDifferenceRepository;

    @Autowired
    private OtpCodeDifferenceMappingRepository otpCodeDifferenceMappingRepository;

    @Autowired
    private BalanceRepository balanceRepository;

    @Autowired
    private OtpCodeRepository otpCodeRepository;

    @Autowired
    private CategorySequenceConfig categorySequenceConfig;

    public List<CategoryResponse> getReport(Long periodId, Long jurisdictionId, Long obligationId) {
        JurisdictionObligation jurisdictionObligation = getJurisdictionObligation(jurisdictionId, obligationId);
        if (jurisdictionObligation == null) return List.of();

        Map<String, CategoryResponse> categoryResponseMap = new LinkedHashMap<>();
        double previousCategoryTotal = 0;
        double ptbi = 50;

        for (JurisdictionObligationDifference jod : jurisdictionObligationDifferenceRepository.findByJurisdictionObligation(jurisdictionObligation)) {
            Difference difference = jod.getDifference();
            CategoryResponse categoryResponse = getCategoryResponse(categoryResponseMap, difference.getCategory());

            TimingResponse timingResponse = getTimingResponse(categoryResponse, difference.getTiming());
            processBalances(timingResponse, difference, jod, periodId);

            categoryResponse.setTotal(categoryResponse.getTotal() + timingResponse.getTotal());
        }

        applyFinalAdjustments(categoryResponseMap, ptbi, previousCategoryTotal);
        return new ArrayList<>(categoryResponseMap.values());
    }

    private JurisdictionObligation getJurisdictionObligation(Long jurisdictionId, Long obligationId) {
        Jurisdiction jurisdiction = jurisdictionRepository.findById(jurisdictionId).orElse(null);
        Obligation obligation = obligationRepository.findById(obligationId).orElse(null);
        return jurisdictionObligationRepository.findByJurisdictionAndObligation(jurisdiction, obligation);
    }

    private CategoryResponse getCategoryResponse(Map<String, CategoryResponse> categoryResponseMap, String category) {
        return categoryResponseMap.computeIfAbsent(category, cat -> {
            CategorySequenceConfig.Category config = getCategoryConfig(cat);
            return new CategoryResponse(config.getCustomName(), config.getSequence());
        });
    }

    private CategorySequenceConfig.Category getCategoryConfig(String category) {
        return categorySequenceConfig.getCategories().stream()
                .filter(c -> c.getName().equalsIgnoreCase(category))
                .findFirst()
                .orElseThrow(() -> new RuntimeException("CategorySequence not found for category: " + category));
    }

    private TimingResponse getTimingResponse(CategoryResponse categoryResponse, String timing) {
        return categoryResponse.getTimings().stream()
                .filter(t -> t.getTiming().equals(timing))
                .findFirst()
                .orElseGet(() -> {
                    TimingResponse newTimingResponse = new TimingResponse(timing);
                    categoryResponse.addTiming(newTimingResponse);
                    return newTimingResponse;
                });
    }

    private void processBalances(TimingResponse timingResponse, Difference difference, JurisdictionObligationDifference jod, Long periodId) {
        List<Balance> balances = balanceRepository.findByJurisdictionObligationDifferenceAndPeriodId(jod, periodId);
        for (Balance balance : balances) {
            for (OtpCodeDifferenceMapping mapping : otpCodeDifferenceMappingRepository.findByDifference(difference)) {
                OtpCode otpCode = otpCodeRepository.findById(mapping.getOtpCode().getOtpId())
                        .orElseThrow(() -> new RuntimeException("OTP Code not found: " + mapping.getOtpCode().getOtpId()));

                OtpCodeResponse otpCodeResponse = getOtpCodeResponse(timingResponse, otpCode.getOtpCode(), otpCode.getOtpCodeDescription());
                otpCodeResponse.addDifference(new DifferenceResponse(difference.getDifferenceName(), balance.getAmount()));
                otpCodeResponse.setTotal(otpCodeResponse.getTotal() + balance.getAmount());
            }
            timingResponse.setTotal(timingResponse.getTotal() + balance.getAmount());
        }
    }

    private OtpCodeResponse getOtpCodeResponse(TimingResponse timingResponse, String otpCode, String otpCodeDescription) {
        return timingResponse.getOtpCodes().stream()
                .filter(o -> o.getOtpCode().equals(otpCode))
                .findFirst()
                .orElseGet(() -> {
                    OtpCodeResponse newOtpCodeResponse = new OtpCodeResponse(otpCode, otpCodeDescription);
                    timingResponse.addOtpCodeResponse(newOtpCodeResponse);
                    return newOtpCodeResponse;
                });
    }

    private void applyFinalAdjustments(Map<String, CategoryResponse> categoryResponseMap, double ptbi, double previousCategoryTotal) {
        for (CategoryResponse categoryResponse : categoryResponseMap.values()) {
            if (categoryResponse.getSequence() == 1) {
                categoryResponse.setTotal(categoryResponse.getTotal() + ptbi);
            } else {
                categoryResponse.setTotal(categoryResponse.getTotal() + previousCategoryTotal);
            }
            previousCategoryTotal = categoryResponse.getTotal();
        }
    }
}

// DTOs

class CategoryResponse {
    private String name;
    private int sequence;
    private double total;
    private List<TimingResponse> timings = new ArrayList<>();

    public CategoryResponse(String name, int sequence) {
        this.name = name;
        this.sequence = sequence;
        this.total = 0.0;
    }

    public void addTiming(TimingResponse timing) {
        this.timings.add(timing);
    }

    @Override
    public String toString() {
        return "CategoryResponse{" +
                "name='" + name + '\'' +
                ", sequence=" + sequence +
                ", total=" + total +
                ", timings=" + timings +
                '}';
    }
}

class TimingResponse {
    private String timing;
    private double total;
    private List<OtpCodeResponse> otpCodes = new ArrayList<>();

    public TimingResponse(String timing) {
        this.timing = timing;
        this.total = 0.0;
    }

    public void addOtpCodeResponse(OtpCodeResponse otpCodeResponse) {
        this.otpCodes.add(otpCodeResponse);
    }

    @Override
    public String toString() {
        return "TimingResponse{" +
                "timing='" + timing + '\'' +
                ", total=" + total +
                ", otpCodes=" + otpCodes +
                '}';
    }
}

class OtpCodeResponse {
    private String otpCode;
    private String otpCodeDescription;
    private double total;
    private List<DifferenceResponse> differences = new ArrayList<>();

    public OtpCodeResponse(String otpCode, String otpCodeDescription) {
        this.otpCode = otpCode;
        this.otpCodeDescription = otpCodeDescription;
        this.total = 0.0;
    }

    public void addDifference(DifferenceResponse difference) {
        this.differences.add(difference);
    }

    @Override
    public String toString() {
        return "OtpCodeResponse{" +
                "otpCode='" + otpCode + '\'' +
                ", otpCodeDescription='" + otpCodeDescription + '\'' +
                ", total=" + total +
                ", differences=" + differences +
                '}';
    }
}

class DifferenceResponse {
    private String differenceName;
    private double amount;

    public DifferenceResponse(String differenceName, double amount) {
        this.differenceName = differenceName;
        this.amount = amount;
    }

    @Override
    public String toString() {
        return "DifferenceResponse{" +
                "differenceName='" + differenceName + '\'' +
                ", amount=" + amount +
                '}';
    }
}

// Entities

@Entity
class Jurisdiction {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long jurisdictionId;
    private String jurisdictionName;

    // Getters and Setters
}

@Entity
class Obligation {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long obligationId;
    private String obligationName;

    // Getters and Setters
}

@Entity
class JurisdictionObligation {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long jurisdictionObligationId;

    @ManyToOne
    private Jurisdiction jurisdiction;

    @ManyToOne
    private Obligation obligation;

    // Getters and Setters
}

@Entity
class JurisdictionObligationDifference {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long jurisdictionObligationDifferenceId;

    @ManyToOne
    private JurisdictionObligation jurisdictionObligation;

    @ManyToOne
    private Difference difference;

    // Getters and Setters
}

@Entity
class OtpCode {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long otpId;
    private String otpCode;
    private String otpCodeDescription;

    // Getters and Setters
}

@Entity
class OtpCodeDifferenceMapping {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long otpCodeDifferenceId;

    @ManyToOne
    private OtpCode otpCode;

    @ManyToOne
    private Difference difference;

    // Getters and Setters
}

@Entity
class Balance {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long balanceId;

    @ManyToOne
    private JurisdictionObligationDifference jurisdictionObligationDifference;

    private Long periodId;
    private double amount;

    // Getters and Setters
}

@Entity
class Difference {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long differenceId;
    private String differenceName;
    private String category;
    private String timing;

    // Getters and Setters
}

// Configuration Class

@Configuration
class CategorySequenceConfig {
    private List<Category> categories;

    public List<Category> getCategories() {
        return categories;
    }

    public void setCategories(List<Category> categories) {
        this.categories = categories;
    }

    public static class Category {
        private String name;
        private int sequence;
        private String customName;

        public String getName() {
            return name;
        }

        public void setName(String name) {
            this.name = name;
        }

        public int getSequence() {
            return sequence;
        }

        public void setSequence(int sequence) {
            this.sequence = sequence;
        }

        public String getCustomName() {
            return customName;
        }

        public void setCustomName(String customName) {
            this.customName = customName;
        }
    }
}

// Repositories

interface JurisdictionRepository extends JpaRepository<Jurisdiction, Long> {
}

interface ObligationRepository extends JpaRepository<Obligation, Long> {
}

interface JurisdictionObligationRepository extends JpaRepository<JurisdictionObligation, Long> {
    @Query("SELECT jo FROM JurisdictionObligation jo WHERE jo.jurisdiction = ?1 AND jo.obligation = ?2")
    JurisdictionObligation findByJurisdictionAndObligation(Jurisdiction jurisdiction, Obligation obligation);
}

interface JurisdictionObligationDifferenceRepository extends JpaRepository<JurisdictionObligationDifference, Long> {
    List<JurisdictionObligationDifference> findByJurisdictionObligation(JurisdictionObligation jurisdictionObligation);
}

interface OtpCodeRepository extends JpaRepository<OtpCode, Long> {
}

interface OtpCodeDifferenceMappingRepository extends JpaRepository<OtpCodeDifferenceMapping, Long> {
    List<OtpCodeDifferenceMapping> findByDifference(Difference difference);
}

interface BalanceRepository extends JpaRepository<Balance, Long> {
    List<Balance> findByJurisdictionObligationDifferenceAndPeriodId(JurisdictionObligationDifference jod, Long periodId);
}
